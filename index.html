<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Your Quote</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--primary-color, #667eea) 0%, var(--secondary-color, #764ba2) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .logo {
            max-width: 200px;
            max-height: 100px;
            margin-bottom: 20px;
        }

        .header h1 {
            color: var(--primary-color, #667eea);
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color, #667eea);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color, #667eea);
        }

        .service-selector {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .service-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .service-card:hover {
            border-color: var(--primary-color, #667eea);
            background: #f8f9fa;
        }

        .service-card.selected {
            border-color: var(--primary-color, #667eea);
            background: #f0f4ff;
        }

        .service-card h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .service-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .service-card .price {
            color: var(--primary-color, #667eea);
            font-size: 18px;
            font-weight: 600;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .quantity-btn {
            background: var(--primary-color, #667eea);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .quantity-btn:hover {
            opacity: 0.8;
        }

        .quantity-display {
            font-size: 18px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        .quote-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .quote-summary h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .quote-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .quote-line:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 18px;
            color: var(--primary-color, #667eea);
        }

        .btn {
            background: var(--primary-color, #667eea);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .error {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .quote-line {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading">
        Loading quote calculator...
    </div>

    <div id="mainContent" class="hidden">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <img id="businessLogo" class="logo hidden" alt="Business Logo">
                <h1 id="businessName">Get Your Quote</h1>
                <p>Select the services you need and get an instant quote</p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error hidden"></div>

            <!-- Services Selection -->
            <div id="servicesCard" class="card">
                <h2>Select Services</h2>
                <div id="servicesList" class="service-selector"></div>
            </div>

            <!-- Contact Info -->
            <div class="card">
                <h2>Your Information</h2>
                <div class="form-group">
                    <label>Your Name</label>
                    <input type="text" id="customerName" placeholder="John Doe" required>
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="customerEmail" placeholder="john@example.com" required>
                </div>
                <div class="form-group">
                    <label>Phone (optional)</label>
                    <input type="text" id="customerPhone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label>Additional Notes</label>
                    <textarea id="customerNotes" rows="4" placeholder="Tell us more about your project..."></textarea>
                </div>
            </div>

            <!-- Quote Summary -->
            <div class="card">
                <h2>Quote Summary</h2>
                <div id="quoteSummary" class="quote-summary">
                    <p style="text-align: center; color: #666;">Select services to see your quote</p>
                </div>
                <button id="submitBtn" class="btn" onclick="submitQuote()" disabled>Request Quote</button>
            </div>

            <!-- Success Message -->
            <div id="successMessage" class="success hidden">
                <h2>✓ Quote Requested!</h2>
                <p style="margin-top: 10px;">We'll get back to you shortly at the email address you provided.</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // FIREBASE CONFIGURATION - REPLACE WITH YOUR CREDENTIALS
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.businessId = null;
        window.businessData = null;
        window.services = [];
        window.selectedServices = new Map();

        // Get business ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        window.businessId = urlParams.get('id');

        if (!window.businessId) {
            showError('Invalid calculator link. Please check your URL.');
        } else {
            await loadCalculator();
        }

        async function loadCalculator() {
            try {
                // Load business data
                const businessDoc = await getDoc(doc(db, 'businesses', window.businessId));
                if (!businessDoc.exists()) {
                    showError('Business not found.');
                    return;
                }

                window.businessData = businessDoc.data();

                // Apply branding
                applyBranding();

                // Load services
                const servicesQuery = query(collection(db, 'services'), where('businessId', '==', window.businessId));
                const snapshot = await getDocs(servicesQuery);
                
                window.services = [];
                snapshot.forEach((doc) => {
                    window.services.push({ id: doc.id, ...doc.data() });
                });

                if (window.services.length === 0) {
                    showError('No services available at this time.');
                    return;
                }

                renderServices();
                
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

            } catch (error) {
                showError('Error loading calculator: ' + error.message);
            }
        }

        function applyBranding() {
            const data = window.businessData;
            
            // Set business name
            document.getElementById('businessName').textContent = data.businessName || 'Get Your Quote';
            document.title = `${data.businessName || 'Quote'} - Get a Quote`;

            // Set logo
            if (data.logoUrl) {
                const logo = document.getElementById('businessLogo');
                logo.src = data.logoUrl;
                logo.classList.remove('hidden');
            }

            // Set colors
            if (data.primaryColor) {
                document.documentElement.style.setProperty('--primary-color', data.primaryColor);
            }
            if (data.secondaryColor) {
                document.documentElement.style.setProperty('--secondary-color', data.secondaryColor);
            }
        }

        function renderServices() {
            const container = document.getElementById('servicesList');
            container.innerHTML = '';

            window.services.forEach(service => {
                const serviceCard = document.createElement('div');
                serviceCard.className = 'service-card';
                serviceCard.dataset.serviceId = service.id;
                
                let priceDisplay = `$${service.basePrice}`;
                if (service.priceType === 'perUnit') {
                    priceDisplay += ' per unit';
                }

                serviceCard.innerHTML = `
                    <h3>${service.name}</h3>
                    <p>${service.description}</p>
                    <div class="price">${priceDisplay}</div>
                    ${service.priceType === 'perUnit' ? `
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="changeQuantity('${service.id}', -1)">−</button>
                            <span class="quantity-display" id="qty-${service.id}">0</span>
                            <button class="quantity-btn" onclick="changeQuantity('${service.id}', 1)">+</button>
                        </div>
                    ` : ''}
                `;

                if (service.priceType !== 'perUnit') {
                    serviceCard.onclick = () => toggleService(service.id);
                }

                container.appendChild(serviceCard);
            });
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        window.toggleService = toggleService;
        window.changeQuantity = changeQuantity;
        window.submitQuote = submitQuote;
        window.calculateTotal = calculateTotal;
        window.updateQuoteSummary = updateQuoteSummary;
    </script>

    <script>
        function toggleService(serviceId) {
            const service = services.find(s => s.id === serviceId);
            if (!service || service.priceType === 'perUnit') return;

            const card = document.querySelector(`[data-service-id="${serviceId}"]`);
            
            if (selectedServices.has(serviceId)) {
                selectedServices.delete(serviceId);
                card.classList.remove('selected');
            } else {
                selectedServices.set(serviceId, { quantity: 1, service });
                card.classList.add('selected');
            }

            updateQuoteSummary();
        }

        function changeQuantity(serviceId, delta) {
            const service = services.find(s => s.id === serviceId);
            if (!service) return;

            const qtyDisplay = document.getElementById(`qty-${serviceId}`);
            let currentQty = parseInt(qtyDisplay.textContent) || 0;
            let newQty = Math.max(0, currentQty + delta);

            qtyDisplay.textContent = newQty;

            const card = document.querySelector(`[data-service-id="${serviceId}"]`);

            if (newQty > 0) {
                selectedServices.set(serviceId, { quantity: newQty, service });
                card.classList.add('selected');
            } else {
                selectedServices.delete(serviceId);
                card.classList.remove('selected');
            }

            updateQuoteSummary();
        }

        function calculateTotal() {
            let total = 0;
            selectedServices.forEach(({ quantity, service }) => {
                if (service.priceType === 'perUnit') {
                    total += service.basePrice * quantity;
                } else {
                    total += service.basePrice;
                }
            });
            return total;
        }

        function updateQuoteSummary() {
            const summaryDiv = document.getElementById('quoteSummary');
            const submitBtn = document.getElementById('submitBtn');

            if (selectedServices.size === 0) {
                summaryDiv.innerHTML = '<p style="text-align: center; color: #666;">Select services to see your quote</p>';
                submitBtn.disabled = true;
                return;
            }

            let html = '<h3>Selected Services:</h3>';
            
            selectedServices.forEach(({ quantity, service }) => {
                const lineTotal = service.priceType === 'perUnit' 
                    ? service.basePrice * quantity 
                    : service.basePrice;
                
                const qtyText = service.priceType === 'perUnit' ? ` × ${quantity}` : '';
                
                html += `
                    <div class="quote-line">
                        <span>${service.name}${qtyText}</span>
                        <span>$${lineTotal.toFixed(2)}</span>
                    </div>
                `;
            });

            const total = calculateTotal();
            html += `
                <div class="quote-line">
                    <span>Total Estimate</span>
                    <span>$${total.toFixed(2)}</span>
                </div>
            `;

            summaryDiv.innerHTML = html;
            submitBtn.disabled = false;
        }

        async function submitQuote() {
            const name = document.getElementById('customerName').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const notes = document.getElementById('customerNotes').value.trim();

            if (!name || !email) {
                alert('Please provide your name and email address.');
                return;
            }

            if (!selectedServices.size) {
                alert('Please select at least one service.');
                return;
            }

            const quoteData = {
                businessId: window.businessId,
                customerName: name,
                customerEmail: email,
                customerPhone: phone,
                notes: notes,
                services: Array.from(selectedServices.values()).map(({ quantity, service }) => ({
                    serviceId: service.id,
                    serviceName: service.name,
                    quantity: quantity,
                    basePrice: service.basePrice,
                    priceType: service.priceType
                })),
                totalEstimate: calculateTotal(),
                createdAt: new Date().toISOString(),
                status: 'pending'
            };

            try {
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = 'Submitting...';

                await addDoc(collection(db, 'quotes'), quoteData);

                // Show success message
                document.getElementById('servicesCard').classList.add('hidden');
                document.querySelector('.card:nth-child(3)').classList.add('hidden');
                document.querySelector('.card:nth-child(4)').classList.add('hidden');
                document.getElementById('successMessage').classList.remove('hidden');

                // Optional: Send email notification here via Cloud Functions or n8n webhook

            } catch (error) {
                alert('Error submitting quote: ' + error.message);
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = 'Request Quote';
            }
        }
    </script>
</body>
</html>
