<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Your Quote</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--primary-color, #667eea) 0%, var(--secondary-color, #764ba2) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .logo {
            max-width: 180px;
            max-height: 80px;
            margin-bottom: 12px;
        }

        .header h1 {
            color: var(--primary-color, #667eea);
            margin-bottom: 6px;
            font-size: 24px;
        }

        .header p {
            color: #666;
            font-size: 15px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color, #667eea);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color, #667eea);
        }

        .service-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .service-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .service-card:hover {
            border-color: var(--primary-color, #667eea);
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .service-card.selected {
            border-color: var(--primary-color, #667eea);
            background: #f0f4ff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .service-card h3 {
            color: #333;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .service-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            flex-grow: 1;
        }

        .service-card .price {
            display: none;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .quantity-btn {
            background: var(--primary-color, #667eea);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .quantity-btn:hover {
            opacity: 0.8;
        }

        .quantity-display {
            font-size: 18px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        .quote-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .quote-summary h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .quote-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .quote-line:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 18px;
            color: var(--primary-color, #667eea);
        }

        .btn {
            background: var(--primary-color, #667eea);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        /* Landing Section */
        .landing-section {
            background: transparent;
            color: var(--landing-text-color, #1f2937);
            padding: 60px 20px 40px;
            text-align: center;
        }

        .landing-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .landing-headline {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 24px;
            line-height: 1.2;
            color: var(--landing-text-color, #1f2937);
        }

        .landing-message {
            font-size: 18px;
            line-height: 1.7;
            margin-bottom: 40px;
            color: var(--landing-text-color, #1f2937);
        }

        .landing-contact {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
            font-size: 16px;
            color: var(--landing-text-color, #1f2937);
        }

        .landing-contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .quote-line {
                flex-direction: column;
                gap: 5px;
            }

            .landing-headline {
                font-size: 32px;
            }

            .landing-message {
                font-size: 16px;
            }

            .landing-contact {
                gap: 24px;
            }

            .service-selector {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1024px) and (min-width: 769px) {
            .service-selector {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading">
        Loading quote calculator...
    </div>

    <!-- Landing Page Section -->
    <div id="landingSection" class="landing-section hidden">
        <div class="landing-container">
            <h1 id="landingHeadline" class="landing-headline"></h1>
            <p id="landingMessage" class="landing-message"></p>
            <div id="landingContact" class="landing-contact"></div>
        </div>
    </div>

    <div id="mainContent" class="hidden">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <img id="businessLogo" class="logo hidden" alt="Business Logo">
                <h1 id="businessName">Get Your Quote</h1>
                <p>Select the services you need and get an instant quote</p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error hidden"></div>

            <!-- Services Selection -->
            <div id="servicesCard" class="card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <h2 style="margin: 0;">Select Services</h2>
                    <div id="servicesDisclaimerText" style="font-size: 13px; color: #666; max-width: 350px; text-align: right; display: none;"></div>
                </div>
                <p style="margin-bottom: 16px; color: #666; font-size: 14px;">Click a product or service to add it to your quote. Click it again to remove it.</p>
                <div id="servicesList" class="service-selector"></div>
                <p style="margin-top: 20px; font-size: 12px; color: #999; line-height: 1.6;">*This quote is an estimate based on the information provided. Actual pricing may vary once the full scope of work is assessed on-site. Final pricing will be confirmed before any work begins.</p>
            </div>

            <!-- Quote Summary -->
            <div class="card">
                <h2>Your Information</h2>
                <p style="margin-bottom: 16px; color: #666; font-size: 14px;">Please provide us with a few quick details then click "Get Quote"</p>
                <div class="form-group">
                    <label>Your Name *</label>
                    <input type="text" id="customerName" placeholder="John Doe" required>
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="customerEmail" placeholder="john@example.com">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="customerPhone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label>Additional Notes</label>
                    <textarea id="customerNotes" rows="4" placeholder="Tell us more about your project..."></textarea>
                </div>
                <div id="errorMessage" style="color: #ef4444; margin-bottom: 16px; display: none;"></div>
                <button id="submitBtn" class="btn" onclick="requestQuote()">Get My Quote</button>
            </div>

            <!-- Quote Summary (Hidden Until Requested) -->
            <div id="quoteSummaryCard" class="card hidden">
                <h2>Your Quote - <span id="quoteNumber"></span></h2>
                <div id="quoteSummary" class="quote-summary"></div>
                <button class="btn" onclick="downloadPDF()" style="background: #10b981; margin-top: 16px;">Download PDF Quote</button>
                <div style="margin-top: 32px; padding: 24px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                    <p style="margin-bottom: 16px; color: #666;">If you'd like to reach out before we do...</p>
                    <div id="businessContactInfo" style="display: flex; justify-content: center; gap: 24px; flex-wrap: wrap;"></div>
                </div>
            </div>

            <!-- Success Message -->
            <div id="successMessage" class="success hidden">
                <h2>‚úì Quote Requested!</h2>
                <p style="margin-top: 10px;">We'll get back to you shortly at the email address you provided.</p>
            </div>
        </div>
    </div>

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyC1M0mrF7xBEZ_6zalErf-xWDrNDfzD_pI",
            authDomain: "quickquote-aaf57.firebaseapp.com",
            projectId: "quickquote-aaf57",
            storageBucket: "quickquote-aaf57.firebasestorage.app",
            messagingSenderId: "979036829063",
            appId: "1:979036829063:web:c587dd1664322dceaacf22"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.businessId = null;
        window.businessData = null;
        window.services = [];
        window.selectedServices = new Map();

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function applyBranding() {
            const data = window.businessData;
            
            // Set business name
            document.getElementById('businessName').textContent = data.businessName || 'Get Your Quote';
            document.title = `${data.businessName || 'Quote'} - Get a Quote`;

            // Set logo
            if (data.logoUrl) {
                const logo = document.getElementById('businessLogo');
                logo.src = data.logoUrl;
                logo.classList.remove('hidden');
            }

            // Set colors
            if (data.primaryColor) {
                document.documentElement.style.setProperty('--primary-color', data.primaryColor);
            }
            if (data.secondaryColor) {
                document.documentElement.style.setProperty('--secondary-color', data.secondaryColor);
            }
            if (data.landingTextColor) {
                document.documentElement.style.setProperty('--landing-text-color', data.landingTextColor);
            }

            // Set landing page content
            const landingHeadline = document.getElementById('landingHeadline');
            const landingMessage = document.getElementById('landingMessage');
            const landingContact = document.getElementById('landingContact');
            const landingSection = document.getElementById('landingSection');

            if (data.landingHeadline || data.landingMessage || data.businessPhone) {
                landingHeadline.textContent = data.landingHeadline || 'Get Your Custom Quote';
                landingMessage.textContent = data.landingMessage || '';
                
                // Build contact info
                let contactHTML = '';
                if (data.contactEmail) {
                    contactHTML += `<div class="landing-contact-item">üìß ${data.contactEmail}</div>`;
                }
                if (data.businessPhone) {
                    contactHTML += `<div class="landing-contact-item">üìû ${data.businessPhone}</div>`;
                }
                landingContact.innerHTML = contactHTML;
                
                landingSection.classList.remove('hidden');
            }
        }

        function renderServices() {
            const container = document.getElementById('servicesList');
            container.innerHTML = '';

            window.services.forEach(service => {
                const serviceCard = document.createElement('div');
                serviceCard.className = 'service-card';
                serviceCard.dataset.serviceId = service.id;

                // Build description with unit type if available
                let description = service.description;
                if (service.priceType === 'perUnit' && service.unitType) {
                    description += (description ? ' ‚Ä¢ ' : '') + service.unitType;
                }

                serviceCard.innerHTML = `
                    <div>
                        <h3>${service.name}</h3>
                        <p>${description}</p>
                    </div>
                    ${service.priceType === 'perUnit' ? `
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="changeQuantity('${service.id}', -1)">‚àí</button>
                            <span class="quantity-display" id="qty-${service.id}">0</span>
                            <button class="quantity-btn" onclick="changeQuantity('${service.id}', 1)">+</button>
                        </div>
                    ` : ''}
                `;

                if (service.priceType !== 'perUnit') {
                    serviceCard.onclick = () => toggleService(service.id);
                }

                container.appendChild(serviceCard);
            });
        }

        async function loadCalculator() {
            try {
                console.log('Loading calculator data...');
                
                // Load business data
                const businessDoc = await getDoc(doc(db, 'businesses', window.businessId));
                console.log('Business doc exists:', businessDoc.exists());
                
                if (!businessDoc.exists()) {
                    console.error('Business not found in database');
                    showError('Business not found.');
                    return;
                }

                window.businessData = businessDoc.data();
                console.log('Business data loaded:', window.businessData);

                // Apply branding
                applyBranding();

                // Show services disclaimer if it exists
                if (window.businessData.servicesDisclaimer) {
                    const disclaimerEl = document.getElementById('servicesDisclaimerText');
                    disclaimerEl.textContent = window.businessData.servicesDisclaimer;
                    disclaimerEl.style.display = 'block';
                }

                // Load services
                const servicesQuery = query(collection(db, 'services'), where('businessId', '==', window.businessId));
                const snapshot = await getDocs(servicesQuery);
                console.log('Services query returned:', snapshot.size, 'documents');
                
                window.services = [];
                snapshot.forEach((doc) => {
                    const serviceData = { id: doc.id, ...doc.data() };
                    // Only include active services (default to true if not set)
                    if (serviceData.active !== false) {
                        window.services.push(serviceData);
                    }
                });
                console.log('Services loaded:', window.services);

                if (window.services.length === 0) {
                    console.warn('No active services available');
                    showError('No services available at this time.');
                    return;
                }

                renderServices();
                console.log('Services rendered successfully');
                
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                console.log('Calculator loaded successfully');

            } catch (error) {
                console.error('Error loading calculator:', error);
                showError('Error loading calculator: ' + error.message);
            }
        }

        // Get business ID from URL and initialize
        (async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            window.businessId = urlParams.get('id');

            console.log('Initializing calculator with business ID:', window.businessId);

            if (!window.businessId) {
                console.error('No business ID provided in URL');
                showError('Invalid calculator link. Please check your URL.');
            } else {
                await loadCalculator();
            }
        })();

        function calculateTotal() {
            let total = 0;
            window.selectedServices.forEach(({ quantity, service }) => {
                if (service.priceType === 'perUnit') {
                    total += service.basePrice * quantity;
                } else {
                    total += service.basePrice;
                }
            });
            return total;
        }

        function generateQuoteNumber() {
            const date = new Date();
            const dateStr = date.getFullYear() + 
                           String(date.getMonth() + 1).padStart(2, '0') + 
                           String(date.getDate()).padStart(2, '0');
            const random = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
            return `QN-${dateStr}-${random}`;
        }

        async function requestQuote() {
            const name = document.getElementById('customerName').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const notes = document.getElementById('customerNotes').value.trim();
            const errorDiv = document.getElementById('errorMessage');

            // Validation
            if (!name) {
                errorDiv.textContent = '‚ö†Ô∏è Please enter your name';
                errorDiv.style.display = 'block';
                return;
            }

            if (!email && !phone) {
                errorDiv.textContent = '‚ö†Ô∏è Please provide either an email address or phone number';
                errorDiv.style.display = 'block';
                return;
            }

            if (!window.selectedServices.size) {
                errorDiv.textContent = '‚ö†Ô∏è Please select at least one service';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';

            // Generate quote number
            const quoteNumber = generateQuoteNumber();
            window.currentQuoteNumber = quoteNumber;

            // Save to Firebase
            const quoteData = {
                quoteNumber: quoteNumber,
                businessId: window.businessId,
                status: 'active',
                viewedAt: null,
                customerName: name,
                customerEmail: email,
                customerPhone: phone,
                notes: notes,
                services: Array.from(window.selectedServices.values()).map(({ quantity, service }) => ({
                    serviceId: service.id,
                    serviceName: service.name,
                    quantity: quantity,
                    basePrice: service.basePrice,
                    priceType: service.priceType
                })),
                totalEstimate: calculateTotal(),
                createdAt: new Date().toISOString()
            };

            try {
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = 'Processing...';

                await addDoc(collection(db, 'quotes'), quoteData);

                // Send webhook to n8n for email notifications
                try {
                    const webhookData = {
                        quoteNumber: quoteNumber,
                        customerName: name,
                        customerEmail: email || 'Not provided',
                        customerPhone: phone || 'Not provided',
                        notes: notes,
                        businessEmail: window.businessData.contactEmail,
                        businessName: window.businessData.businessName,
                        businessPhone: window.businessData.businessPhone || '',
                        services: Array.from(window.selectedServices.values()).map(({ quantity, service }) => ({
                            name: service.name,
                            quantity: quantity,
                            price: service.basePrice,
                            priceType: service.priceType,
                            lineTotal: service.priceType === 'perUnit' ? service.basePrice * quantity : service.basePrice
                        })),
                        totalEstimate: calculateTotal(),
                        timestamp: new Date().toISOString()
                    };

                    await fetch('https://elijahchristo.app.n8n.cloud/webhook/send-quote', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(webhookData)
                    });
                } catch (webhookError) {
                    console.error('Webhook error (non-critical):', webhookError);
                    // Don't fail the quote submission if webhook fails
                }

                // Show quote summary with pricing
                displayQuoteSummary(quoteNumber);

                // Scroll to quote
                document.getElementById('quoteSummaryCard').scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                console.error('Error saving quote:', error);
                errorDiv.textContent = '‚ö†Ô∏è Error processing quote: ' + error.message;
                errorDiv.style.display = 'block';
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = 'Get My Quote';
            }
        }

        function displayQuoteSummary(quoteNumber) {
            const summaryDiv = document.getElementById('quoteSummary');
            const quoteNumberSpan = document.getElementById('quoteNumber');
            const contactDiv = document.getElementById('businessContactInfo');
            
            quoteNumberSpan.textContent = quoteNumber;

            let html = '<h3>Selected Services:</h3>';
            
            window.selectedServices.forEach(({ quantity, service }) => {
                const lineTotal = service.priceType === 'perUnit' 
                    ? service.basePrice * quantity 
                    : service.basePrice;
                
                const qtyText = service.priceType === 'perUnit' ? ` √ó ${quantity}` : '';
                
                html += `
                    <div class="quote-line">
                        <span>${service.name}${qtyText}</span>
                        <span>$${lineTotal.toFixed(2)}</span>
                    </div>
                `;
            });

            const total = calculateTotal();
            html += `
                <div class="quote-line">
                    <span>Total Estimate</span>
                    <span>$${total.toFixed(2)}</span>
                </div>
            `;

            summaryDiv.innerHTML = html;

            // Show business contact info
            const data = window.businessData;
            let contactHTML = '';
            if (data.contactEmail) {
                contactHTML += `<div>üìß ${data.contactEmail}</div>`;
            }
            if (data.businessPhone) {
                contactHTML += `<div>üìû ${data.businessPhone}</div>`;
            }
            contactDiv.innerHTML = contactHTML;

            // Show the quote card
            document.getElementById('quoteSummaryCard').classList.remove('hidden');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const data = window.businessData;
            const quoteNumber = window.currentQuoteNumber;
            const name = document.getElementById('customerName').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();

            // Header
            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234);
            doc.text(data.businessName || 'Quote', 20, 20);
            
            doc.setFontSize(24);
            doc.setTextColor(0, 0, 0);
            doc.text(`Quote ${quoteNumber}`, 20, 35);

            // Customer Info
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text('PREPARED FOR:', 20, 50);
            doc.setTextColor(0, 0, 0);
            doc.text(name, 20, 57);
            if (email) doc.text(email, 20, 64);
            if (phone) doc.text(phone, 20, 71);

            // Date
            doc.setTextColor(100, 100, 100);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 140, 50);

            // Services Table
            const tableData = [];
            window.selectedServices.forEach(({ quantity, service }) => {
                const lineTotal = service.priceType === 'perUnit' 
                    ? service.basePrice * quantity 
                    : service.basePrice;
                
                const qtyText = service.priceType === 'perUnit' ? quantity : '1';
                
                tableData.push([
                    service.name,
                    qtyText,
                    `$${service.basePrice.toFixed(2)}`,
                    `$${lineTotal.toFixed(2)}`
                ]);
            });

            doc.autoTable({
                startY: 85,
                head: [['Service', 'Qty', 'Unit Price', 'Total']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234] },
                foot: [[
                    { content: 'TOTAL ESTIMATE', colSpan: 3, styles: { halign: 'right', fontStyle: 'bold' }},
                    { content: `$${calculateTotal().toFixed(2)}`, styles: { fontStyle: 'bold' }}
                ]],
                showFoot: 'lastPage'
            });

            // Footer
            const finalY = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('If you\'d like to reach out before we do:', 20, finalY);
            
            doc.setTextColor(0, 0, 0);
            if (data.contactEmail) {
                doc.text(`Email: ${data.contactEmail}`, 20, finalY + 7);
            }
            if (data.businessPhone) {
                doc.text(`Phone: ${data.businessPhone}`, 20, finalY + 14);
            }

            // Save PDF
            doc.save(`Quote-${quoteNumber}.pdf`);
        }

        function toggleService(serviceId) {
            const service = window.services.find(s => s.id === serviceId);
            if (!service || service.priceType === 'perUnit') return;

            const card = document.querySelector(`[data-service-id="${serviceId}"]`);
            
            if (window.selectedServices.has(serviceId)) {
                window.selectedServices.delete(serviceId);
                card.classList.remove('selected');
            } else {
                window.selectedServices.set(serviceId, { quantity: 1, service });
                card.classList.add('selected');
            }
        }

        function changeQuantity(serviceId, delta) {
            const service = window.services.find(s => s.id === serviceId);
            if (!service) return;

            const qtyDisplay = document.getElementById(`qty-${serviceId}`);
            let currentQty = parseInt(qtyDisplay.textContent) || 0;
            let newQty = Math.max(0, currentQty + delta);

            qtyDisplay.textContent = newQty;

            const card = document.querySelector(`[data-service-id="${serviceId}"]`);

            if (newQty > 0) {
                window.selectedServices.set(serviceId, { quantity: newQty, service });
                card.classList.add('selected');
            } else {
                window.selectedServices.delete(serviceId);
                card.classList.remove('selected');
            }
        }

        window.toggleService = toggleService;
        window.changeQuantity = changeQuantity;
        window.requestQuote = requestQuote;
        window.calculateTotal = calculateTotal;
        window.downloadPDF = downloadPDF;
    </script>
</body>
</html>
